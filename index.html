<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Data Vault Racer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            touch-action: manipulation; /* Prevent zoom on double-tap */
        }
        
        /* Game Area */
        #game-area {
            position: relative;
            width: 100%;
            height: 100%;
            background: #1a1a2e; /* Dark blue/purple */
            overflow: hidden;
            border-left: 2px dashed #2a2a4e;
            border-right: 2px dashed #2a2a4e;
            /* Establish a stacking context for game elements */
            z-index: 1;
        }

        /* Lanes */
        .lane {
            position: absolute;
            height: 100%;
            width: 33.33%;
            border-right: 2px dashed #2a2a4e;
        }
        .lane:nth-child(1) { left: 0; }
        .lane:nth-child(2) { left: 33.33%; }
        .lane:nth-child(3) { left: 66.66%; border-right: none; }

        /* Player (Buggy) */
        #player {
            position: absolute;
            bottom: 10%;
            width: 30px; /* Changed for car aspect ratio */
            height: 50px; /* Changed for car aspect ratio */
            /* Start centered */
            left: calc(50% - 15px); /* Adjusted for new width */
            transition: left 0.1s ease-out;
            will-change: left;
            z-index: 10;
        }

        /* Game Items */
        .item {
            position: absolute;
            width: 30px;
            height: 30px;
            will-change: transform;
            z-index: 5;
        }
        
        .gem {
            background-color: #00ffff;
            border-radius: 8px;
            box-shadow: 0 0 15px #00ffff;
        }
        
        .corruptor {
            background-color: #ff0055;
            border-radius: 50%;
            box-shadow: 0 0 15px #ff0055;
            transform: rotate(45deg); /* Make it spiky-ish */
        }
        
        /* Corruptor Warning Arrow */
        .warning-arrow {
            position: absolute;
            top: 10px;
            font-size: 2rem;
            color: #ff0055;
            animation: pulse-warning 0.5s infinite alternate;
            z-index: 20;
        }

        @keyframes pulse-warning {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }

        /* Save Button */
        #save-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Default size for number */
            font-weight: 700; /* Default weight for number */
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            /* Ensure save button is below modals */
            z-index: 100;
            line-height: 1; /* For "Vault It" */
        }
        #save-button:active {
            transform: scale(0.95);
        }
        #save-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            font-size: 2.25rem; /* Larger font for number */
            font-weight: 900;
        }

        /* Message Box */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            transition: opacity 0.5s ease-out;
            /* Ensure message box is below modal overlay but above game */
            z-index: 200;
        }

        /* Modal */
        .modal {
            background: rgba(26, 26, 46, 0.95);
            border-top: 4px solid #00ffff;
        }
        
        /* New rule to fix stacking context */
        #modal-overlay {
            /* Force this overlay into its own rendering layer above all game elements */
            z-index: 300; 
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .btn-upgrade {
            transition: all 0.2s ease;
        }
        
        .btn-upgrade:disabled {
            background-color: #333 !important;
            color: #777 !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* REMOVED: .btn-upgrade:disabled .cost { display: none; } */
        
        /* Quiz Answer Buttons */
        .btn-answer {
            transition: all 0.2s ease;
            background-color: #3b82f6; /* Blue */
        }
        .btn-answer.correct {
            background-color: #22c55e; /* Green */
        }
        .btn-answer.wrong {
            background-color: #ef4444; /* Red */
        }
        .btn-answer:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .btn-answer:not(:disabled):hover {
            transform: scale(1.03);
        }
        
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen w-screen">

    <div id="game-container" class="relative w-full h-full max-w-lg mx-auto bg-black flex flex-col">

        <!-- Header: Scores -->
        <header class="w-full bg-gray-900 p-4 z-50 shadow-lg flex-shrink-0">
            <div class="flex justify-between items-center">
                <!-- Left: Vault -->
                <div class="text-left w-1/3">
                    <div class="text-sm font-bold text-green-400 uppercase">VAULT</div>
                    <div id="vault-score" class="text-3xl font-black text-green-300">0</div>
                </div>
                
                <!-- Center: Cart -->
                <div class="text-center w-1/3">
                    <div class="text-sm font-bold text-yellow-400 uppercase">CART</div>
                    <div id="cart-score" class="text-4xl font-black text-yellow-300">0</div>
                </div>
                
                <!-- Right: Level & Time -->
                <div class="text-right w-1/3">
                    <div class="text-xs font-bold text-gray-400 uppercase">LEVEL</div>
                    <div id="level-display" class="text-2xl font-black">1</div>
                    <div class="text-xs font-bold text-gray-400 uppercase mt-1">TIME</div>
                    <div id="timer-display" class="text-2xl font-black">30</div>
                </div>
            </div>
        </header>

        <!-- Game Area -->
        <main id="game-area" class="flex-1">
            <div class="lane"></div>
            <div class="lane"></div>
            <div class="lane"></div>

            <!-- Player -->
            <div id="player">
                <!-- Simple top-down car -->
                <svg viewBox="0 0 60 100" fill="#31f7f7" class="w-full h-full">
                        <path d="M15 10 L45 10 C50 10, 55 15, 55 20 L55 80 C55 95, 45 100, 40 100 L20 100 C15 100, 5 95, 5 80 L5 20 C5 15, 10 10, 15 10 Z" stroke="#FFFFFF" stroke-width="5"/>
                        <!-- Windshield -->
                        <rect x="15" y="25" width="30" height="20" fill="#000" rx="5" ry="5" stroke="#FFF" stroke-width="2"/>
                        <!-- Headlights -->
                        <rect x="15" y="5" width="10" height="5" fill="#FF0" rx="2" ry="2"/>
                        <rect x="35" y="5" width="10" height="5" fill="#FF0" rx="2" ry="2"/>
                        <!-- Taillights -->
                        <rect x="15" y="90" width="10" height="5" fill="#F00" rx="2" ry="2"/>
                        <rect x="35" y="90" width="10" height="5" fill="#F00" rx="2" ry="2"/>
                </svg>
            </div>
            
            <!-- Warning Arrow -->
            <div id="warning-arrow" class="warning-arrow hidden">â–¼</div>
        </main>

        <!-- SAVE Button -->
        <button id="save-button" class="text-xl font-black tracking-tight text-center">
            Vault It
        </button>

        <!-- Message Box (for "CRASH!") -->
        <div id="message-box" class="hidden opacity-0"></div>

        <!-- Modals Overlay -->
        <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center">
            
            <!-- Start Menu -->
            <div id="start-menu-modal" class="modal text-center p-8 rounded-lg shadow-2xl w-11/12 max-w-sm">
                <h1 class="text-4xl font-black text-cyan-300 mb-4">Data Vault Racer</h1>
                <p class="text-lg mb-6">Tap a lane to move your car! Catch <span class="text-cyan-300">Gems</span> and dodge <span class="text-red-500">Corruptors</span>.</p>
                <p class="text-md mb-8">Press <span class="text-green-400">Vault It</span> to secure your <span class="text-yellow-300">CART</span> points to your <span class="text-green-300">VAULT</span>. If you crash, you lose all <span class="text-red-500">un-secured</span> points in your CART (but not in your vault)!</p>
                <button id="start-game-button" class="w-full bg-cyan-500 text-gray-900 font-bold py-4 px-6 rounded-lg text-2xl transform hover:scale-105 transition-transform">Start Game</button>
            </div>
            
            <!-- Quiz Modal -->
            <div id="quiz-modal" class="modal p-6 rounded-lg shadow-2xl w-11/12 max-w-sm hidden">
                <h2 class="text-3xl font-black text-cyan-300 mb-2">Bonus Quiz!</h2>
                <p class="text-lg mb-4">Answer correctly to <span class="text-yellow-300">DOUBLE</span> the points you just earned!</p>
                <div id="quiz-question" class="text-xl font-semibold mb-6">...</div>
                
                <div id="quiz-answers" class="space-y-3 mb-6">
                    <!-- Answer buttons will be dynamically added here -->
                </div>
                
                <div id="quiz-result" class="text-lg font-bold mb-4 h-6"></div>
                <button id="continue-to-shop-button" class="w-full bg-cyan-500 text-gray-900 font-bold py-3 px-6 rounded-lg text-xl transform hover:scale-105 transition-transform hidden">Continue</button>
            </div>


            <!-- Shop Modal -->
            <div id="shop-modal" class="modal p-6 rounded-lg shadow-2xl w-11/12 max-w-sm hidden">
                <h2 class="text-3xl font-black text-cyan-300 mb-2">Level <span id="shop-level-display">1</span> Complete!</h2>
                <p class="text-lg mb-2 text-gray-300">Use your VAULT points to purchase upgrades.</p>
                <p id="shop-bonus-text" class="text-lg font-bold text-green-400 mb-6 h-6"></p> <!-- h-6 to reserve space -->
                
                <div class="space-y-3 mb-8">
                    <!-- Speed Upgrades -->
                    <h3 class="font-bold text-yellow-300 uppercase">Speed Upgrades</h3>
                    <button id="upgrade-fastEngine" class="btn-upgrade w-full bg-yellow-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Faster Engine</span>
                        <span class="cost bg-gray-900 text-yellow-300 py-1 px-3 rounded-full text-sm">200</span>
                    </button>
                    <button id="upgrade-biggerScoop" class="btn-upgrade w-full bg-yellow-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Bigger Scoop (20 pts)</span>
                        <span class="cost bg-gray-900 text-yellow-300 py-1 px-3 rounded-full text-sm">400</span>
                    </button>
                    <button id="upgrade-gemMagnet" class="btn-upgrade w-full bg-yellow-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Gem Magnet</span>
                        <span class="cost bg-gray-900 text-yellow-300 py-1 px-3 rounded-full text-sm">600</span>
                    </button>

                    <!-- Backup Upgrades -->
                    <h3 class="font-bold text-green-300 uppercase pt-3">Backup Upgrades</h3>
                    <button id="upgrade-fastSave" class="btn-upgrade w-full bg-green-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Fast Save (1.5s)</span>
                        <span class="cost bg-gray-900 text-green-300 py-1 px-3 rounded-full text-sm">200</span>
                    </button>
                    <button id="upgrade-shield" class="btn-upgrade w-full bg-green-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Shield (1 per level)</span>
                        <span class="cost bg-gray-900 text-green-300 py-1 px-3 rounded-full text-sm">400</span>
                    </button>
                    <button id="upgrade-warningSystem" class="btn-upgrade w-full bg-green-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Warning System</span>
                        <span class="cost bg-gray-900 text-green-300 py-1 px-3 rounded-full text-sm">600</span>
                    </button>
                    <button id="upgrade-redundantSystem" class="btn-upgrade w-full bg-green-500 text-gray-900 font-bold p-3 rounded-lg flex justify-between items-center">
                        <span>Redundant System</span>
                        <span class="cost bg-gray-900 text-green-300 py-1 px-3 rounded-full text-sm">800</span>
                    </button>
                </div>
                <button id="continue-to-next-level-button" class="w-full bg-cyan-500 text-gray-900 font-bold py-4 px-6 rounded-lg text-2xl transform hover:scale-105 transition-transform">Start Next Level</button>
            </div>
            
            <!-- Game Over Modal -->
            <div id="game-over-modal" class="modal text-center p-8 rounded-lg shadow-2xl w-11/12 max-w-sm hidden">
                <h1 class="text-4xl font-black text-cyan-300 mb-4">Game Over!</h1>
                <p class="text-lg mb-2">Your final score is:</p>
                <div id="final-score" class="text-6xl font-black text-green-300 mb-8">0</div>
                <p class="text-md mb-8">You learned the value of backing up your data (to the VAULT)!</p>
                <button id="play-again-button" class="w-full bg-cyan-500 text-gray-900 font-bold py-4 px-6 rounded-lg text-2xl transform hover:scale-105 transition-transform">Play Again</button>
            </div>

            <!-- Crash Modal -->
            <div id="crash-modal" class="modal text-center p-8 rounded-lg shadow-2xl w-11/12 max-w-sm hidden">
                <h1 class="text-4xl font-black text-red-500 mb-4">CRASH!</h1>
                <p class="text-lg mb-2">You lost</p>
                <div id="lost-score-display" class="text-6xl font-black text-yellow-300 mb-6">0</div>
                <p id="crash-reason-text" class="text-md mb-4">points from your CART because you didn't SAVE them to the VAULT!</p>
                <p class="text-sm text-gray-300 mb-8">A good Backup/DR strategy, like creating automatic backup rules, protects your data from unexpected loss.</p>
                <button id="continue-game-button" class="w-full bg-cyan-500 text-gray-900 font-bold py-4 px-6 rounded-lg text-2xl transform hover:scale-105 transition-transform">Continue</button>
            </div>

        </div>

    </div>

    <script type="module">
        // --- DOM Elements ---
        const gameArea = document.getElementById('game-area');
        const player = document.getElementById('player');
        const vaultScoreEl = document.getElementById('vault-score');
        const cartScoreEl = document.getElementById('cart-score');
        const levelDisplay = document.getElementById('level-display');
        const timerDisplay = document.getElementById('timer-display');
        const saveButton = document.getElementById('save-button');
        const messageBox = document.getElementById('message-box');
        
        // Modals
        const modalOverlay = document.getElementById('modal-overlay');
        const startMenuModal = document.getElementById('start-menu-modal');
        const quizModal = document.getElementById('quiz-modal');
        const shopModal = document.getElementById('shop-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const crashModal = document.getElementById('crash-modal');
        
        // Modal Buttons
        const startGameButton = document.getElementById('start-game-button');
        const playAgainButton = document.getElementById('play-again-button');
        const continueGameButton = document.getElementById('continue-game-button');
        const continueToNextLevelButton = document.getElementById('continue-to-next-level-button');
        const shopLevelDisplay = document.getElementById('shop-level-display');
        
        // Quiz Elements
        const quizQuestionEl = document.getElementById('quiz-question');
        const quizAnswersEl = document.getElementById('quiz-answers');
        const quizResultEl = document.getElementById('quiz-result');
        const continueToShopButton = document.getElementById('continue-to-shop-button');
        
        // Warning Arrow
        const warningArrow = document.getElementById('warning-arrow');

        // --- Game State ---
        let vaultScore = 0;
        let cartScore = 0;
        let pointsThisLevel = 0; // New: Track points *per level* for quiz bonus
        let currentLevel = 1;
        const maxLevels = 3;
        let levelTimer = 30; // Default, will be set by config
        let playerLane = 1; // 0 = left, 1 = center, 2 = right
        let items = []; // { id, element, type, lane, y, warning }
        let nextItemId = 0;
        let saveCooldown = 0; // in seconds
        let shieldUsedThisLevel = false;
        let gameState = 'start_menu'; // 'start_menu', 'racing', 'quiz', 'shop', 'game_over', 'paused_crash'
        let lastTimestamp = 0;
        let spawnTimer = 0;
        let systemCrashTimer = 0; // Timer for random system crash
        let currentQuizQuestion = null;

        // --- Game Config (Easy to Customize) ---
        const config = {
            levelDuration: 30,      // How long each level lasts in seconds
            
            baseItemSpeed: 350,       // Base speed of falling items (pixels/sec)
            baseSpawnRate: 0.9,       // Base time between spawns (seconds)
            corruptorChance: 0.45,    // 45% chance for an item to be a Corruptor
            
            systemCrashMinTime: 10,   // Minimum time for a random system crash
            systemCrashMaxTime: 25,   // Maximum time for a random system crash
            
            gemValue: 10,
            saveCooldownTime: 3,      // Cooldown for the SAVE button (seconds)
            
            // Upgrades
            upgrades: {
                fastEngine: false,
                biggerScoop: false,
                gemMagnet: false,
                fastSave: false,
                shield: false,
                warningSystem: false,
                redundantSystem: false // New upgrade
            },
            upgradeCosts: {
                fastEngine: 200,
                biggerScoop: 400,
                gemMagnet: 600,
                fastSave: 200,
                shield: 400,
                warningSystem: 600,
                redundantSystem: 800 // Cost for new upgrade
            },
            
            // --- QUIZ QUESTIONS ---
            // Add your questions from Google Forms here
            // `correctIndex` is the 0-based index of the correct answer
            quizQuestions: [
                {
                    question: "What does 'RPO' (Recovery Point Objective) measure?",
                    answers: [
                        "How long it takes to recover",
                        "How much data you can afford to lose",
                        "The number of recovery points",
                        "The objective of the recovery"
                    ],
                    correctIndex: 1
                },
                {
                    question: "What does 'RTO' (Recovery Time Objective) measure?",
                    answers: [
                        "The time it takes to repair a system",
                        "The target time to recover from a disaster",
                        "The total number of recovery options",
                        "The time of the recovery test"
                    ],
                    correctIndex: 1
                },
                {
                    question: "A backup that copies *only* the data that has changed since the last *full* backup is called:",
                    answers: [
                        "A differential backup",
                        "An incremental backup",
                        "A full backup",
                        "A snapshot"
                    ],
                    correctIndex: 0
                },
                {
                    question: "A backup that copies *only* the data that has changed since the last backup *of any kind* is called:",
                    answers: [
                        "A differential backup",
                        "An incremental backup",
                        "A partial backup",
                        "A change log"
                    ],
                    correctIndex: 1
                }
            ]
            
        };
        // ------------------------------------

        // --- Game Loop ---
        function gameLoop(timestamp) {
            if (!lastTimestamp) {
                lastTimestamp = timestamp;
            }
            const deltaTime = (timestamp - lastTimestamp) / 1000; // seconds
            lastTimestamp = timestamp;

            if (gameState === 'racing') {
                updateRacing(deltaTime);
            } 
            
            requestAnimationFrame(gameLoop);
        }

        // --- Game Logic ---
        function updateRacing(deltaTime) {
            // Update Timers
            levelTimer -= deltaTime;
            spawnTimer -= deltaTime;
            
            // Update new System Crash Timer
            if (systemCrashTimer > 0) {
                systemCrashTimer -= deltaTime;
                if (systemCrashTimer <= 0) {
                    triggerSystemCrash();
                }
            }

            if (saveCooldown > 0) {
                saveCooldown -= deltaTime;
                saveButton.textContent = Math.ceil(saveCooldown);
                // Style for number
                saveButton.classList.remove('text-xl', 'font-black', 'tracking-tight');

                if (saveCooldown <= 0) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Vault It';
                    // Style for "Vault It"
                    saveButton.classList.add('text-xl', 'font-black', 'tracking-tight');
                }
            }

            // End level
            if (levelTimer <= 0) {
                timerDisplay.textContent = 0;
                if (currentLevel < maxLevels) {
                    // Go to Quiz first!
                    openQuiz();
                } else {
                    gameOver();
                }
                return;
            }

            timerDisplay.textContent = Math.ceil(levelTimer);

            // Spawn Items
            if (spawnTimer <= 0) {
                spawnItem();
                // Increase spawn rate per level
                const spawnRateMultiplier = 1 + (currentLevel - 1) * 0.5;
                spawnTimer = config.baseSpawnRate / spawnRateMultiplier; 
            }

            // Update Items
            const gameHeight = gameArea.clientHeight;
            const playerY = gameHeight * 0.8; // Player's effective Y position
            // Increase speed per level
            const itemSpeed = config.baseItemSpeed * (1 + (currentLevel - 1) * 0.3); 

            items.forEach((item, index) => {
                item.y += itemSpeed * deltaTime;
                
                // Show warning if enabled
                if (item.type === 'corruptor' && config.upgrades.warningSystem && !item.warning && item.y > -50) {
                    showWarning(item.lane);
                    item.warning = true; // Only show once
                }

                item.element.style.transform = `translateY(${item.y}px)`;

                // Collision Detection
                if (item.y > playerY && item.y < playerY + 50 && item.lane === playerLane) {
                    if (item.type === 'gem') {
                        collectGem(item);
                    } else {
                        hitCorruptor(item);
                    }
                    removeItem(item, index);
                }
                // Remove off-screen items
                else if (item.y > gameHeight) {
                    removeItem(item, index);
                }
            });
        }

        function spawnItem() {
            const type = Math.random() < config.corruptorChance ? 'corruptor' : 'gem'; 
            const lane = Math.floor(Math.random() * 3);
            const id = nextItemId++;

            const itemElement = document.createElement('div');
            itemElement.className = `item ${type}`;
            itemElement.style.left = `${lane * 33.33 + 16.66}%`; // Center in lane
            itemElement.style.transform = 'translate(-50%, -50px)';
            itemElement.style.top = '0';
            
            const item = { id, element: itemElement, type, lane, y: -50, warning: false };
            
            // Apply Gem Magnet upgrade
            if (type === 'gem' && config.upgrades.gemMagnet) {
                // This is a simple implementation: just spawn gems in the player's lane
                item.lane = playerLane;
                itemElement.style.left = `${playerLane * 33.33 + 16.66}%`;
            }

            items.push(item);
            gameArea.appendChild(itemElement);
        }

        function removeItem(item, index) {
            items.splice(index, 1);
            item.element.remove();
        }

        function collectGem(item) {
            const points = config.upgrades.biggerScoop ? 20 : config.gemValue;
            cartScore += points;
            pointsThisLevel += points; // Add to this level's total
            updateScores();
        }
        
        function setSystemCrashTimer() {
            const min = config.systemCrashMinTime;
            const max = config.systemCrashMaxTime;
            // Set timer to a random value within the config range
            systemCrashTimer = Math.random() * (max - min) + min;
        }

        function triggerSystemCrash() {
            // Prevent it from re-triggering this level
            systemCrashTimer = -1; 

            // Check for "Redundant System" upgrade first
            if (config.upgrades.redundantSystem) {
                showMessage("Redundancy Saved System!", "cyan");
                return; // System is safe
            }
            
            // Check for shield
            if (config.upgrades.shield && !shieldUsedThisLevel) {
                shieldUsedThisLevel = true;
                showMessage("SHIELD USED!", "green");
                return; // Shield saved the cart
            }
            
            // CHECK FOR EMPTY CART
            if (cartScore === 0) {
                showMessage("Well done! Cart was empty.", "green");
                return; // No penalty
            }
            
            // --- No protection! System Crash! ---
            const lostScore = cartScore;
            cartScore = 0;
            // Also subtract from pointsThisLevel, since they were lost
            pointsThisLevel = Math.max(0, pointsThisLevel - lostScore);
            updateScores();
            
            gameState = 'paused_crash'; // Pause the game
            
            // Customize the crash modal message for a system crash
            document.getElementById('crash-modal').querySelector('h1').textContent = "SYSTEM CRASH!";
            document.getElementById('crash-reason-text').textContent = "A system-wide failure occurred! You lost all un-SAVED points from your CART.";
            document.getElementById('lost-score-display').textContent = lostScore;
            
            showModal(crashModal);
        }

        function hitCorruptor(item) {
            if (config.upgrades.shield && !shieldUsedThisLevel) {
                shieldUsedThisLevel = true;
                showMessage("SHIELD USED!", "green");
            } else {
               // CHECK FOR EMPTY CART
               if (cartScore === 0) {
                   showMessage("Phew! Cart was empty.", "green");
                   return; // No penalty
               }
               
               const lostScore = cartScore; // Store the lost score
               cartScore = 0;
               // Also subtract from pointsThisLevel
               pointsThisLevel = Math.max(0, pointsThisLevel - lostScore);
               updateScores();
               
               gameState = 'paused_crash'; // Pause the game
               
               // Set the crash modal message for a regular collision
               document.getElementById('crash-modal').querySelector('h1').textContent = "CRASH!";
               document.getElementById('crash-reason-text').textContent = "points from your CART because you didn't SAVE them to the VAULT!";
               document.getElementById('lost-score-display').textContent = lostScore; // Show lost score in modal
               
               showModal(crashModal); // Show the new crash modal

                gameArea.style.backgroundColor = '#5a1a2e'; // Flash red
                setTimeout(() => { gameArea.style.backgroundColor = '#1a1a2e'; }, 200);
            }
        }

        function showWarning(lane) {
            warningArrow.style.left = `${lane * 33.33 + 16.66}%`; // Center in lane
            warningArrow.style.transform = 'translateX(-50%)';
            warningArrow.classList.remove('hidden');
            setTimeout(() => {
                warningArrow.classList.add('hidden');
            }, 500); // Show warning for 0.5s
        }

        // --- Player Movement ---
        function setPlayerPosition(newLane) {
            if (gameState !== 'racing' || newLane === playerLane) return; // No change or not playing

            playerLane = newLane;
            
            // Apply Fast Engine upgrade
            const transitionTime = config.upgrades.fastEngine ? 0.05 : 0.1;
            player.style.transition = `left ${transitionTime}s ease-out`;
            
            const laneCenter = playerLane * 33.33 + 16.66;
            player.style.left = `calc(${laneCenter}% - 15px)`; // Adjusted for 30px width
        }

        function movePlayer(direction) {
            if (gameState !== 'racing') return;
            let newLane = playerLane;
            if (direction === 'left') {
                newLane = Math.max(0, playerLane - 1);
            } else if (direction === 'right') {
                newLane = Math.min(2, playerLane + 1); // <-- THE FIX WAS HERE!
            }
            setPlayerPosition(newLane);
        }

        function handleGameAreaInteraction(clientX) {
            if (gameState !== 'racing') return;
            const rect = gameArea.getBoundingClientRect();
            const clickX = clientX - rect.left; 
            const gameWidth = gameArea.clientWidth;
            const laneWidth = gameWidth / 3;

            let targetLane;
            if (clickX < laneWidth) {
                targetLane = 0; // Left lane
            } else if (clickX < laneWidth * 2) {
                targetLane = 1; // Center lane
            } else {
                targetLane = 2; // Right lane
            }
            setPlayerPosition(targetLane);
        }

        // --- UI & State Functions ---
        function updateScores() {
            vaultScoreEl.textContent = vaultScore;
            cartScoreEl.textContent = cartScore;
        }

        function saveCartToVault() {
            if (saveCooldown > 0) return;
            
            // Points are already added to pointsThisLevel when collected
            // Only move from cart to vault
            vaultScore += cartScore;
            cartScore = 0;
            updateScores();

            saveCooldown = config.upgrades.fastSave ? 1.5 : config.saveCooldownTime;
            saveButton.disabled = true;
            saveButton.textContent = Math.ceil(saveCooldown);
            saveButton.classList.remove('text-xl', 'font-black', 'tracking-tight');
        }
        
        function showMessage(text, color) {
            messageBox.textContent = text;
            messageBox.style.color = color;
            messageBox.classList.remove('hidden');
            messageBox.style.opacity = 1;

            setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => messageBox.classList.add('hidden'), 500);
            }, 1000);
        }
        
        function showModal(modalElement) {
            modalOverlay.classList.remove('hidden');
           [startMenuModal, quizModal, shopModal, gameOverModal, crashModal].forEach(m => m.classList.add('hidden'));
            modalElement.classList.remove('hidden');
        }

        function hideModals() {
            modalOverlay.classList.add('hidden');
        }

        function startGame() {
            gameState = 'paused'; // Paused until level starts
            vaultScore = 0;
            cartScore = 0;
            currentLevel = 1;
            playerLane = 1; // Reset logical lane
            
            // --- Visually reset the player to the center lane ---
            const laneCenter = playerLane * 33.33 + 16.66;
            player.style.transition = 'none'; // Snap to position
            player.style.left = `calc(${laneCenter}% - 15px)`; // Adjusted for 30px width
            
            // Restore animation duration for gameplay
            setTimeout(() => {
                const transitionTime = config.upgrades.fastEngine ? 0.05 : 0.1;
                player.style.transition = `left ${transitionTime}s ease-out`;
            }, 50);
            
            
            // Reset upgrades
            for (let key in config.upgrades) {
                config.upgrades[key] = false;
            }
            
            // Reset shop button states
            document.querySelectorAll('.btn-upgrade').forEach(btn => {
                const upgradeId = btn.id.replace('upgrade-', '');
                btn.disabled = false;
                // Find the original button text (span)
                const textSpan = btn.querySelector('span:first-child');
                const btnText = textSpan ? textSpan.textContent : 'Upgrade'; // Fallback
                
                // Determine color
                const isBackupUpgrade = ['fastSave', 'shield', 'warningSystem', 'redundantSystem'].includes(upgradeId);
                const colorClass = isBackupUpgrade ? 'text-green-300' : 'text-yellow-300';
                
                btn.innerHTML = `<span>${btnText}</span> <span class="cost bg-gray-900 ${colorClass} py-1 px-3 rounded-full text-sm">${config.upgradeCosts[upgradeId]}</span>`;
            });


            startLevel();
        }

        function startLevel() {
            gameState = 'racing';
            levelTimer = config.levelDuration;
            timerDisplay.textContent = levelTimer;
            shieldUsedThisLevel = false;
            pointsThisLevel = 0; // Reset per-level point tracker
            items.forEach(item => item.element.remove());
            items = [];
            
            setSystemCrashTimer(); // Set the random crash timer for this level
            
            levelDisplay.textContent = currentLevel;
            updateScores();
            hideModals();
            lastTimestamp = performance.now();
            if (currentLevel === 1) requestAnimationFrame(gameLoop); // Only start loop once
        }
        
        // --- New Quiz Functions ---
        
        function openQuiz() {
            gameState = 'quiz';
            
            // Select a random question for this level
            // Filter out questions we've already used (if we add more)
            currentQuizQuestion = config.quizQuestions[Math.floor(Math.random() * config.quizQuestions.length)];
            
            // Populate Quiz Modal
            quizQuestionEl.textContent = currentQuizQuestion.question;
            quizAnswersEl.innerHTML = ''; // Clear old answers
            quizResultEl.textContent = '';
            continueToShopButton.classList.add('hidden');
            
            currentQuizQuestion.answers.forEach((answer, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn-answer w-full text-white font-bold p-3 rounded-lg text-left';
                btn.textContent = answer;
                btn.onclick = () => checkQuizAnswer(index, btn);
                quizAnswersEl.appendChild(btn);
            });
            
            showModal(quizModal);
        }
        
        function checkQuizAnswer(selectedIndex, selectedButton) {
            // Disable all buttons
            quizAnswersEl.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            const correct = selectedIndex === currentQuizQuestion.correctIndex;
            
            if (correct) {
                selectedButton.classList.add('correct');
                quizResultEl.textContent = `Correct! +${pointsThisLevel} Bonus!`;
                quizResultEl.className = 'text-lg font-bold mb-4 h-6 text-green-400';
                
                // Apply bonus: add pointsThisLevel again to the vault
                vaultScore += pointsThisLevel;
                updateScores();
            } else {
                selectedButton.classList.add('wrong');
                // Highlight correct answer
                quizAnswersEl.children[currentQuizQuestion.correctIndex].classList.add('correct');
                quizResultEl.textContent = 'Incorrect! No bonus.';
                quizResultEl.className = 'text-lg font-bold mb-4 h-6 text-red-400';
            }
            
            // Show continue button
            continueToShopButton.classList.remove('hidden');
        }

        function openShop(bonusText = "") {
            gameState = 'shop';
            shopLevelDisplay.textContent = currentLevel;
            
            // Set bonus text
            const bonusEl = document.getElementById('shop-bonus-text');
            if (bonusText.includes("Correct!")) {
                bonusEl.textContent = bonusText;
                bonusEl.className = 'text-lg font-bold text-green-400 mb-6 h-6';
            } else if (bonusText.includes("Incorrect!")) {
                bonusEl.textContent = bonusText;
                bonusEl.className = 'text-lg font-bold text-red-400 mb-6 h-6';
            } else {
                bonusEl.textContent = ''; // No bonus, just the instruction
                bonusEl.className = 'text-lg font-bold text-green-400 mb-6 h-6'; // Reset classes
            }

            showModal(shopModal);
            
            // Update button states based on cost
            document.querySelectorAll('.btn-upgrade').forEach(btn => {
                const upgradeId = btn.id.replace('upgrade-', '');
                if (!config.upgrades[upgradeId]) {
                    if (vaultScore < config.upgradeCosts[upgradeId]) {
                        btn.disabled = true;
                    } else {
                        btn.disabled = false;
                    }
                }
            });
        }
        
        function buyUpgrade(upgradeId) {
            const cost = config.upgradeCosts[upgradeId];
            if (vaultScore >= cost && !config.upgrades[upgradeId]) {
                vaultScore -= cost;
                config.upgrades[upgradeId] = true;
                updateScores();
                
                // Update button
                const btn = document.getElementById(`upgrade-${upgradeId}`);
                btn.disabled = true;
                btn.innerHTML = `<span>${btn.firstElementChild.textContent}</span> <span class="text-sm">PURCHASED (${cost})</span>`;
                
                // Re-check other buttons' disabled state
                document.querySelectorAll('.btn-upgrade').forEach(b => {
                    const id = b.id.replace('upgrade-', '');
                    if (!config.upgrades[id] && vaultScore < config.upgradeCosts[id]) {
                        b.disabled = true;
                    }
                });
            }
        }

        function gameOver() {
            gameState = 'game_over';
            document.getElementById('final-score').textContent = vaultScore;
            showModal(gameOverModal);
        }

       function resumeFromCrash() {
           hideModals();
           gameState = 'racing';
           lastTimestamp = performance.now(); // Reset timestamp to prevent game jump
       }

        // --- Event Listeners ---
        
        // Player Movement (Tap on Mobile)
        gameArea.addEventListener('touchstart', (e) => {
            if (gameState !== 'racing') return;
            e.preventDefault(); // Prevent scrolling/zooming
            handleGameAreaInteraction(e.touches[0].clientX);
        }, { passive: false });

        // Player Movement (Click on Desktop)
        gameArea.addEventListener('click', (e) => {
            handleGameAreaInteraction(e.clientX);
        });

        // Player Movement (Keyboard for testing)
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') movePlayer('left');
            if (e.key === 'ArrowRight') movePlayer('right');
        });

        // Save Button
        saveButton.addEventListener('click', saveCartToVault);

        // Modal Buttons
        startGameButton.addEventListener('click', startGame);
        playAgainButton.addEventListener('click', startGame);
        continueGameButton.addEventListener('click', resumeFromCrash);
        continueToNextLevelButton.addEventListener('click', () => {
            currentLevel++;
            startLevel();
        });
        
        // New Quiz Button
        continueToShopButton.addEventListener('click', () => {
            // Pass the quiz result text to the shop
            const bonusMessage = quizResultEl.textContent;
            openShop(bonusMessage);
        });
        
        // Shop Buttons
        document.querySelectorAll('.btn-upgrade').forEach(btn => {
            btn.addEventListener('click', () => {
                buyUpgrade(btn.id.replace('upgrade-', ''));
            });
        });
        
        // --- Init ---
        // Set initial player position (already set in HTML, but good to be sure)
        const laneCenter = playerLane * 33.33 + 16.66;
        player.style.left = `calc(${laneCenter}% - 15px)`; // Adjusted for 30px width
        updateScores();
        timerDisplay.textContent = config.levelDuration; // Show correct start time

    </script>
</body>
</html>


